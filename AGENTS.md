# Agent 协作与上下文优化指南 (AGENTS.md)

本指南旨在规范 Agent 在开发过程中的技能激活行为，优化上下文消耗，提升任务执行效率。

## 1. 技能激活策略 (Skills Activation)

### 强制入口 (Mandatory Entry)
- **每次必触发**：任何用户输入/任务开始前，必须去你的技能清单，先调用 `using-superpowers`。
- **统一分派**：后续是否触发其他技能，由 `using-superpowers` 决定。
- **禁止例外**：不得以“简单问题”“无需技能”等理由跳过。
- **可观测性**：必须明确输出“已触发 using-superpowers + 是否分派其他技能”的执行摘要。

### 精准唤醒词
- **分析/搜索**：优先调用 `search` 子代理进行 read-only 调研，避免主 Agent 陷入琐碎搜索。
- **重构/优化**：使用 `refactor` 或 `optimize` 明确意图。
- **验证/测试**：在修改后立即调用 `verify` 或 `test` 技能。

### 意图声明
Agent 在执行前应声明其“当前工作模式”：
- `[PLANNING]`：正在进行多步任务规划。
- `[EXECUTING]`：正在执行具体的代码修改。
- `[VERIFYING]`：正在运行测试验证结果。

## 2. 上下文节约 (Context Optimization)

### 任务拆解 (Plan-and-Execute)
- 严禁一次性执行超过 3 个不相关的子任务。
- 复杂任务必须先生成 `TODO.md` 或调用 `TodoWrite` 工具。
- 每个子任务完成后，应总结核心变化，并“清理”不需要的中间上下文。

### 外部记忆化 (Offloading)
- **大文件处理**：对于超过 500 行的文件，禁止全文 Read。应先用 `Grep` 定位，再进行局部读取。
- **中间状态**：将复杂的分析报告写入 `docs/notes/` 或 `tmp/`，Agent 仅在后续对话中引用其路径和摘要。

### 工具选择优化
- **搜索**：能用 `Glob` 找到的文件，不用 `Grep`；能用 `Grep` 找到的字符串，不用 `SearchCodebase`。
- **编辑**：优先使用 `SearchReplace` 进行精准修改，避免全量重写。

## 3. 技能控制 (Skills Control)

### 核心原则
- **按需加载**：只有在任务明确需要时才激活特定的 Skills。
- **反馈闭环**：每项技能执行后必须提供明确的执行结果摘要。
- **避免冗余**：如果一个任务可以通过标准 CLI 工具完成，则不应创建复杂的自定义 Skill。

### 变更注释规范 (Change Annotation)
- **强制要求**：每次对代码、路由、配置或文档进行修改后，必须在修改处添加简短注释，说明变更目的（Why）、影响范围（Scope）与验证方法（Verify）。
- **注释形式**：
  - 代码文件：在变更附近使用合适的行内/块级注释（JS/Vue 使用 `//` 或 `/* */`；模板遵循框架推荐方式）。
  - 文档文件：在调整段落紧邻位置添加 HTML 注释 `<!-- ... -->` 描述本次修改。
- **安全约束**：注释中不得包含密钥、访问令牌或私有链接等敏感信息。
- **与用户偏好冲突时**：若用户明确禁止添加注释，应遵循用户指令，记录在任务说明中。

---
*本文件由 Agent 自动维护，作为协作契约。*
